@page "/calendar"
@page "/"
@attribute [Authorize]
@inject ApiService Api
@inject DialogService DialogService

<div class="flex justify-between items-center mb-1">
    <h1 style="margin:0">Calendar</h1>
    <button class="btn btn-primary btn-sm" @onclick="OnNewEvent">+ New Event</button>
</div>

<RadzenScheduler @ref="_scheduler" TItem="CalendarEventOccurrenceDto" Data="_events"
                 StartProperty="StartDate" EndProperty="EndDate" TextProperty="Title"
                 SlotSelect="OnSlotSelect" AppointmentSelect="OnEventSelect"
                 SlotRender="OnSlotRender"
                 LoadData="OnLoadData"
                 @bind-SelectedIndex="_selectedViewIndex"
                 @bind-Date="_currentDate"
                 Style="height: calc(100vh - 180px);">
    <RadzenMonthView />
    <RadzenWeekView />
    <RadzenDayView />
</RadzenScheduler>

@code {
    private RadzenScheduler<CalendarEventOccurrenceDto>? _scheduler;
    private List<CalendarEventOccurrenceDto> _events = new();
    private List<PersonDto> _people = new();
    private int _selectedViewIndex = 0;
    private DateTime _currentDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        _people = await Api.GetAsync<List<PersonDto>>("api/people") ?? new();
    }

    private async Task OnLoadData(SchedulerLoadDataEventArgs args)
    {
        var start = args.Start.ToString("o");
        var end = args.End.ToString("o");
        _events = await Api.GetAsync<List<CalendarEventOccurrenceDto>>($"api/events?start={start}&end={end}") ?? new();
    }

    private async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        // Month view slots are full-day ranges (midnight to midnight).
        // Detect this and navigate to day view instead of opening the dialog.
        var isMonthSlot = args.Start.TimeOfDay == TimeSpan.Zero
                          && args.End.TimeOfDay == TimeSpan.Zero
                          && (args.End - args.Start).TotalDays <= 1;

        if (isMonthSlot)
        {
            _currentDate = args.Start.Date;
            _selectedViewIndex = 2; // Day view
            StateHasChanged();
            return;
        }

        // Week/Day view: selecting a time slot opens new event dialog
        await OpenNewEventDialog(args.Start, args.End);
    }

    private async Task OnNewEvent()
    {
        var now = DateTime.Now;
        var start = new DateTime(now.Year, now.Month, now.Day, now.Hour + 1, 0, 0);
        var end = start.AddHours(1);

        await OpenNewEventDialog(start, end);
    }

    private async Task OpenNewEventDialog(DateTime start, DateTime end)
    {
        var newEvent = new CalendarEventDto
        {
            StartDate = start,
            EndDate = end,
            IsAllDay = start.TimeOfDay == TimeSpan.Zero && end.TimeOfDay == TimeSpan.Zero
        };

        var result = await DialogService.OpenAsync<EventDialog>("New Event",
            new Dictionary<string, object>
            {
                { "Event", newEvent },
                { "People", _people },
                { "IsNew", true }
            },
            new DialogOptions { Width = "95vw", Style = "max-width: 500px" });

        if (result is true)
        {
            await _scheduler!.Reload();
        }
    }

    private async Task OnEventSelect(SchedulerAppointmentSelectEventArgs<CalendarEventOccurrenceDto> args)
    {
        var existing = await Api.GetAsync<CalendarEventDto>($"api/events/{args.Data.SourceEventId}");
        if (existing == null) return;

        var result = await DialogService.OpenAsync<EventDialog>("Edit Event",
            new Dictionary<string, object>
            {
                { "Event", existing },
                { "People", _people },
                { "IsNew", false }
            },
            new DialogOptions { Width = "95vw", Style = "max-width: 500px" });

        if (result is true or false)
        {
            await _scheduler!.Reload();
        }
    }

    private void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        // No custom rendering needed for now
    }
}
